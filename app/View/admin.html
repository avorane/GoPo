<html>
  <head>
  
   	<title>GOPO</title>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge; charset=utf-8" />
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
    
    <link rel="stylesheet" href="node_modules/material-design-lite/material.min.css">
    <link rel="stylesheet" href="node_modules/highcharts/css/highcharts.css">
    <script src="node_modules/material-design-lite//material.min.js"></script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="node_modules/highcharts/js/highcharts.js"></script>
	
	<link rel="stylesheet" href="/app/View/Styles_index_admin.css">
	
  </head>
  <body>

        <!-- Simple header with fixed tabs. -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-tabs">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row" >
          <!-- Title -->
          
          <div class="mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-phone" style="float:left" >
        	<span class="mdl-layout-title" style="margin-left:-40px;">GOPO</span>
          </div>
          
          <div class="mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-phone" style="float:right" onclick="document.getElementById('oModal1').style.display = 'block';">
        	<span class="mdl-layout-title">Mode Administrateur</span>
          </div>
          
          <div class="mdl-cell mdl-cell--2-col mdl-cell--2-col-tablet mdl-cell--2-col-phone" style="float:right;">
        	<img  class='article-image' src='/app/View/Images/actualiser.png' onclick="document.getElementById('form_admin').submit();" style='cursor:pointer;' border='0' alt=''>
         </div>
          
          <div class="mdl-cell mdl-cell--2-col mdl-cell--2-col-tablet mdl-cell--2-col-phone" style="float:right;text-align:right;">
        	<img  class='article-image' src='/app/View/Images/dell_white.png' onclick="document.location.href='http://176.159.137.250:8090/login'" style='color:white;fill:white;height:32px;width:32px;margin-left:20%;cursor:pointer;' border='0' alt=''>
          </div>

          
        </div>
        <!-- Tabs -->
        <div class="mdl-layout__tab-bar mdl-js-ripple-effect" style="border-top: 1px solid black;">
          <a href="#fixed-tab-1" class="mdl-layout__tab is-active">Le Monde</a>
          <a href="#fixed-tab-2" id="sortZones_admin" class="mdl-layout__tab">Gestion des lieux</a>
          <a href="#fixed-tab-3" id="sortPlayers_admin" class="mdl-layout__tab">Gestion des Utilisateurs</a>
          <a href="#fixed-tab-4" class="mdl-layout__tab" onclick="getClassementPlayers();">Statistiques</a>
        </div>
      </header>
      <main class="mdl-layout__content">
        <section class="mdl-layout__tab-panel is-active" id="fixed-tab-1">
          <div class="page-content">
          	<input id="pac-input" class="controls" type="text" placeholder="Rechercher un lieu">
          	<div id="map" style="height:86%;"></div>
          </div>
        </section>
		    <script>
		    
		        var marker;
		        var map;
		        var list_zones = [];

				function initAutocomplete() {
			        var map = new google.maps.Map(document.getElementById('map'), {
			          center: {lat: 44.9339, lng: 1.8535},
			          zoom: 13,
			          mapTypeId: 'roadmap'
			        });
			        
			        var uluru = {lat: 44.9339, lng: 1.8535};
			        marker = new google.maps.Marker({
			          position: uluru,
			          map: map
			        });
			        
			        marker.addListener('click', function() {
			            $("#oModal1").show();
			        });
			
			        // Create the search box and link it to the UI element.
			        var input = document.getElementById('pac-input');
			        var searchBox = new google.maps.places.SearchBox(input);
			        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
			
			        // Bias the SearchBox results towards current map's viewport.
			        map.addListener('bounds_changed', function() {
			          searchBox.setBounds(map.getBounds());
			        });
			        
			        map.addListener('click', function(ev) {
			            marker.setPosition(ev.latLng);
			        });
			
			        searchBox.addListener('places_changed', function() {
			          var places = searchBox.getPlaces();
			
			          if (places.length == 0) {
			            return;
			          }
			
			          // For each place, get the icon, name and location.
			          var bounds = new google.maps.LatLngBounds();
			          places.forEach(function(place) {
			            if (!place.geometry) {
			              console.log("Returned place contains no geometry");
			              return;
			            }
			            var icon = {
			              url: place.icon,
			              size: new google.maps.Size(71, 71),
			              origin: new google.maps.Point(0, 0),
			              anchor: new google.maps.Point(17, 34),
			              scaledSize: new google.maps.Size(25, 25)
			            };
			            if (marker !== undefined) {
			                marker.setOptions({
			                  map: map,
			                  icon: icon,
			                  title: place.name,
			                  position: place.geometry.location
			                });
			            } else {
			                marker = new google.maps.Marker({
			                  map: map,
			                  icon: icon,
			                  title: place.name,
			                  position: place.geometry.location
			                });
			            }
			            if (place.geometry.viewport) {
			              // Only geocodes have viewport.
			              bounds.union(place.geometry.viewport);
			            } else {
			              bounds.extend(place.geometry.location);
			            }
			          });
			          map.fitBounds(bounds);
			        });
			        displayZones();
			      }
			      
                function ajoutlieu() {
                    var lat = marker.position.lat();
                    var lng = marker.position.lng();
                    var nom = $("#nom_lieu").val();
                    var descriptif = $("#descriptif").val();
                    var cout = $("#cout").val();
                    var gain = $("#gain").val();
                    var rayon = $("#rayon").val();
                    $.ajax({
                        url: "http://176.159.137.250:8090/ajoutlieu",
						type: "PUT",
						data: {latitude: lat, longitude: lng, libelle: nom, description: descriptif, valeur: cout, gain: gain, rayon: rayon},
						success: function(data) {
							//$("#oModal1").hide();
							$("form#form_file").submit(function(e) {
								alert('J\'envoie');
								
								
								
							    e.preventDefault();
							    var formData = new FormData();  
							    formData.append('file', $('input[type=file]')[0].files[0]);
								
								$.ajax({
								    url : "http://176.159.137.250:8090/upload",
								    type: "POST",
								    data : formData,
								    processData: false,
								    contentType: false,
								    success:function(data, textStatus, jqXHR){
								        alert('OK')
								    },
								    error: function(jqXHR, textStatus, errorThrown){
								        //if fails     
								    }
								});
							    
							});
							$("form#form_file").submit();
						},

				       error : function(data){
							alert('Erreur 400, ajout lieu')
				       }
					}); 
			   }
        		//zones
        		//affichage liste
        		function getListZones_admin() {
					$.get("http://176.159.137.250:8090/zones_admin",
						function(data) {
							sortListZones_admin(data);
						},
						"json"
					);
				}
				
				function sortListZones_admin(data) {
					$("#listZones_admin").empty();
					$.each(data['zones'], function(key, value) {
						if(value['isActif'] == 1){
							actif1="Checked";
							actif2="";
						}else{
							actif2="Checked";
							actif1="";
						}
						$('#listZones_admin').append('<li class="mdl-list__item mdl-list__item--three-line" style="margin-top:-40px;border-bottom: 1px #b3b3b3 solid;"><span class="mdl-list__item-primary-content"><img  class="article-image" src="/app/View/Images/paysage.png" style="" border="0" alt=""><span style="padding-left: 20px;">' + value['libelle'] + '</span><button style="" class="list_lieux_btn mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" id="btn_valider_'+value['id_zone']+'" type="button">Valider</button><span style="float:right;margin-right:20px;margin-left:10px;margin-top:30px;"><input type="radio" id="contactChoice1" style="" name="contact_'+value['id_zone']+'" value="1" '+actif1+'><label for="contactChoice1">Active</label><input type="radio" id="contactChoice2" name="contact_'+value['id_zone']+'" value="0" '+actif2+'><label for="contactChoice2">Inactive</label></span><span style="float:right;margin-right:20px;margin-left:10px;">Prix:</br></br><input id="valeur_'+value['id_zone']+'" type="number" value="'+ value['valeur'] +'" style="width:75px;height:40px;"></span><span style="float:right;margin-right:20px;margin-left:10px;">Gain:</br></br><input id="gain_'+value['id_zone']+'" type="number" value="' + value['gain'] + '" style="width:75px;height:40px;"></span><span style="float:right;margin-right:20px;margin-left:10px;">Rayon:</br></br><input id="perimetre_'+value['id_zone']+'" type="number" value="' + value['perimetre'] + '" style="width:75px;height:40px;"></span><span class="mdl-list__item-text-body" style="max-width:70%;">' + value['description'] + '</span></span></li>');

						$('#btn_valider_'+value['id_zone']).click(function() {
							gestion_etat_zone(value['id_zone']);
						});
						
						
					});
				}
				
				$("#sortZones_admin").click(function() {
					getListZones_admin();
				});
				
				//gestion etat lieu
				function gestion_etat_zone(id_zone) {
					etat = $('input[name="contact_'+id_zone+'"]:checked').val();
					gain = document.getElementById('gain_'+id_zone).value;
					perimetre = document.getElementById('perimetre_'+id_zone).value;
					valeur = document.getElementById('valeur_'+id_zone).value;
					$.ajax({
						url:"http://176.159.137.250:8090/gest_zones",
						type: 'PUT',
						data: {etat: etat, id_zone: id_zone, gain: gain, perimetre: perimetre, valeur: valeur},
						success: function(data) {
							getListZones_admin();
						},
						error : function(data){
							alert('Erreur 400, gestion etat lieu')
				       }
						
					})
				}
				
				//users
				//affichage liste
				function getListPlayers_admin() {
					$.get("http://176.159.137.250:8090/players_admin",
						function(data) {
							sortListPlayers_admin(data);
						},
						"json"
					);
				}
				
				function sortListPlayers_admin(data) {
					$("#listPlayers_admin").empty();
					$.each(data['players'], function(key, value) {
						if(value['banni'] == 0){
							action="Bannir";
						}else{
							action="Débannir";
						}
						$('#listPlayers_admin').append('<li class="mdl-list__item mdl-list__item--three-line" style="margin-top:-40px;border-bottom: 1px #b3b3b3 solid;"><span class="mdl-list__item-primary-content"><img  class=\'article-image\' src=\'/app/View/Images/utilisateur.png\' style=\'margin-top: 15px;\' border=\'0\' alt=\'\'><span style="padding-left: 20px;">' + value['prenom'] +" "+ value['nom'] + '</span><button style="" class="list_lieux_btn mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" onclick="gestion_etat_user('+value['banni']+', '+value['id_utilisateur']+');" type="button">'+action+'</button> <span style="float:right;margin-right:20px;margin-left:30px;">Credit:</br></br><input type="number" value="' + value['credit'] + '" style="width:75px;height:40px;"></span></span></li>');
					});
				}
				
				$("#sortPlayers_admin").click(function() {
					getListPlayers_admin();
				});
				
				//gestion etat user
				function gestion_etat_user(etat, id_user) {
					$.ajax({
						url:"http://176.159.137.250:8090/gest_users",
						type: 'PUT',
						data: {etat: etat, id_user: id_user},
						success: function(data) {
							getListPlayers_admin();
						},
						error : function(data){
							alert('Erreur 400, gestion etat user')
				       }
						
					})
				}
				
				function displayZones() {
					for (var area in list_zones) {
						area.setMap(null);
					}
					list_zones = [];
					$.ajax({
						url: "http://176.159.137.250:8090/admin_zones",
						type: "GET",
						success: function(data) {
							$.each(data, function(key, value) {
								var latlng = new google.maps.LatLng(value.latitude, value.longitude);
								var circle =  new google.maps.Circle({
                    				center: latlng,
                    				map: map,
                    				radius: value.rayon,          // IN METERS.
                    				fillColor: "#00FF00",
                    				fillOpacity: 0.5,
                    				strokeColor: "#FFF",
                    				strokeWeight: 0         // DON'T SHOW CIRCLE BORDER.
                				});
                				list_zones.push(circle);
							});
						},
						error : function(data){
							alert('Erreur 400, display zones')
				       }
					})
				}
				
				$("#file_input_text").click(function() {
					$("#filetoupload").click();
				})
				
        </script>
         <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqwPesSRd4j-HDQdCI78AY-_P6qPr2u3w&libraries=places&callback=initAutocomplete"></script>
        <section class="mdl-layout__tab-panel" id="fixed-tab-2">
          <div class="page-content">
          	<ul class="mdl-list" id="listZones_admin" style="margin-top:-10px;">
			</ul>
          </div>
        </section>
        
        <section class="mdl-layout__tab-panel" id="fixed-tab-3">
          <div class="page-content">
          	<ul class="mdl-list" id="listPlayers_admin" style="margin-top:-10px;">
			</ul>
          </div>
        </section>
        <section class="mdl-layout__tab-panel" id="fixed-tab-4">
          <div class="page-content">
          	<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
			  <div class="mdl-tabs__tab-bar">
			      <a href="#classement-panel" style="width:33%;" class="mdl-tabs__tab is-active" onclick="getClassementPlayers();" >Classement</a>
			      <a href="#zones-panel" style="width:33%;" class="mdl-tabs__tab" onclick="getHistogram();">Zones Libres / Zones Occupées</a>
			      <a href="#achat_zones" style="width:33%;" class="mdl-tabs__tab" onclick="getHistoAchat();">Evolution de l'occupation</a>
			  </div>
			
			  <div class="mdl-tabs__panel is-active" id="classement-panel">
				<div id="containerPlayers" style="height:75%;width:95%;"></div>
			  </div>
			  
			  <div class="mdl-tabs__panel" id="zones-panel">
				<div id="containerZones" style="height:75%;width:95%;"></div>
			  </div>
			  
			  <div class="mdl-tabs__panel" id="achat_zones">
				  <div id="container" style="height:75%;width:95%;"></div>
			  </div>
			</div>
          	
          	<script>
          	
          		var fileInputTextDiv;
				var fileInput;
				var fileInputText;
				$(document).ready(function(){
					fileInputTextDiv = document.getElementById('file_input_text_div');
					fileInput = document.getElementById('file_input_file');
					fileInputText = document.getElementById('file_input_text');
					fileInput.addEventListener('change', changeInputText);
					fileInput.addEventListener('change', changeState);
				});
				
				function changeInputText() {
				  var str = fileInput.value;
				  var i;
				  if (str.lastIndexOf('\\')) {
				    i = str.lastIndexOf('\\') + 1;
				  } else if (str.lastIndexOf('/')) {
				    i = str.lastIndexOf('/') + 1;
				  }
				  fileInputText.value = str.slice(i, str.length);
				}
				
				function changeState() {
				  if (fileInputText.value.length != 0) {
				    if (!fileInputTextDiv.classList.contains("is-focused")) {
				      fileInputTextDiv.classList.add('is-focused');
				    }
				  } else {
				    if (fileInputTextDiv.classList.contains("is-focused")) {
				      fileInputTextDiv.classList.remove('is-focused');
				    }
				  }
				}
          	
          	    function getHistogram() {
          	        var dataLibre = [null, null];
          	        var dataOccupee = [null, null];
          	        $.get(
          	            "http://176.159.137.250:8090/histogram",
          	            function (data) {
          	                console.log(data.libre);
          	                dataLibre[0] = data.libre;
          	                dataOccupee[1] = data.occupee;
          	                Highcharts.chart('containerZones', {
				                chart: {
				                    type: 'column'
				                },
				                title: {
				                    text: 'Statistiques des zones disponibles / occupées'
				                },
				                subtitle: {
				                    text: ''
				                },
				                xAxis: {
				                    title: {
				                        text: 'Dénombrement'
				                    }
				                },
				                yAxis: {
				                    title: {
				                        text: 'Nombre'
				                    }
				                },
				                series: [
                                    { name: 'Zones Libres', color: '#00FF00', data: dataLibre }, 
                                    { name: 'Zones Occupées', color: 'red', data: dataOccupee }
                                ]
				            });
          	            }, "json"
          	        );
				}
				
				function getHistoAchat() {
					var processed_json = new Array();
					var processed_json2 = new Array();
          	        $.get(
          	            "http://176.159.137.250:8090/stat_achat_zone",
          	            function (data) {
          	            	
	          	        for (i = 0; i < data.length; i++){
	                        processed_json.push(data[i].nombre);
	                        processed_json2.push(data[i].date);
	                    }
	                    
							Highcharts.chart('container', {
						    chart: {
						        type: 'line'
						    },
						    title: {
						        text: 'Statistiques d achat de zones à l année'
						    },
						    subtitle: {
						        text: ''
						    },
						    xAxis: {
						        categories: processed_json2
						    },
						    yAxis: {
						        title: {
						            text: 'Nombre d achats'
						        }
						    },
						    plotOptions: {
						        line: {
						            dataLabels: {
						                enabled: true
						            },
						            enableMouseTracking: false
						        }
						    },
						    series: [{
						        name: "zones",
						        data: processed_json
						    }]
						});
          	            }, "json"
          	        );
				}
				
				function getClassementPlayers() {
					var processed_json = new Array();
					var processed_json2 = new Array();
          	        $.get(
          	            "http://176.159.137.250:8090/stat_classement_players",
          	            function (data) {
          	            	
	          	        for (i = 0; i < data.length; i++){
	                        processed_json.push(data[i].credit);
	                        processed_json2.push(data[i].pseudo);
	                    }
	                    
						Highcharts.chart('containerPlayers', {
					    chart: {
					        type: 'column'
					    },
					    title: {
					        text: 'Top 10 des joueurs'
					    },
					    subtitle: {
					        text: ''
					    }, 
					    xAxis: {
					        categories: processed_json2,
					        crosshair: true
					    },
					    yAxis: {
					        min: 0,
					        title: {
					            text: 'Credit'
					        }
					    },
					    tooltip: {
					        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
					        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
					            '<td style="padding:0"><b>{point.y:.1f} credits</b></td></tr>',
					        footerFormat: '</table>',
					        shared: true,
					        useHTML: true
					    },
					    plotOptions: {
					        column: {
					            pointPadding: 0.2,
					            borderWidth: 0
					        }
					    },
					    series: [{
					        name: 'Joueurs',
					        data: processed_json
					
					    }]
					});
          	            }, "json"
          	        );
				}
          	

			</script>
          	
          </div>
        </section>
      </main>
      <!--POPUP ACHAT LIEU -->
    <div id="oModal1" class="oModal1" style="overflow-y:none;display:none;pointer-events: all;">
		<div style="border-radius:4px;">
			<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-phone" style="overflow-y:hidden;">
				<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-phone mdl-grid portfolio-max-width">
					<div class="mdl-textfield mdl-js-textfield">
						<input class="mdl-textfield__input" type="text" id="nom_lieu" />
						<label class="mdl-textfield__label" for="nom_lieu">Nom du lieu</label>
					</div>
				</div>
				<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-phone mdl-grid portfolio-max-width">
					<div class="mdl-textfield mdl-js-textfield">
						<input class="mdl-textfield__input" type="text" id="adresse_lieu" />
						<label class="mdl-textfield__label" for="adresse_lieu">Adresse du lieu</label>
					</div>
				</div>
				<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-phone mdl-grid portfolio-max-width">
					<div class="mdl-textfield mdl-js-textfield">
						<input class="mdl-textfield__input" type="text" id="descriptif" />
						<label class="mdl-textfield__label" for="descriptif">Descriptif</label>
					</div>
				</div>
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:left;">
					<span>Coût du lieu : </span>
				</div>
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:right;">
					<input type="number" id="cout" value="100" min="1" />
				</div>
				
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:left;">
					<span>Gain du lieu : </span>
				</div>
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:right;">
					<input type="number" id="gain" value="10" min="1" />
				</div>
				
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:left;">
					<span>Rayon du lieu : </span>
				</div>
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:right;">
					<input type="number" id="rayon" value="50" min="1" />
				</div>
				<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone mdl-grid portfolio-max-width" style="float:right;">
					<form id="form_file" action="http://176.159.137.250:8090/uploadfile" enctype="multipart/form-data" method="post">
					 <div class="file_input_div">
					    <div class="file_input">
					      <label class="image_input_button mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect mdl-button--colored">
					        <i class="material-icons">file_upload</i>
					        <input id="file_input_file" class="none" type="file" />
					      </label>
					    </div>
					    <div id="file_input_text_div" class="mdl-textfield mdl-js-textfield textfield-demo">
					      <input class="file_input_text mdl-textfield__input" type="text" disabled readonly id="file_input_text" />
					      <label class="mdl-textfield__label" for="file_input_text"></label>
					    </div>
					  </div>
					  <input type="submit">
					</form>
				</div>
				<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-phone">
					<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone" style="float:left;padding-top:30px;text-align:center;">
						<button type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" onclick="document.getElementById('oModal1').style.display = 'none';" style="border: solid 1px #0089c2;padding:0;margin:auto;width:144px;height:40px;color: #0089c2;;text-align:center;background-color: white;border-radius: 4px;">Annuler</button>
					</div>
					<div class="mdl-cell mdl-cell--6-col mdl-cell--6-col-tablet mdl-cell--6-col-phone" style="float:right;font-size:20px;padding-top:30px;text-align:center;">
						<button type="button" id="ajouter_lieu" onclick="ajoutlieu();" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="border: solid 1px #0089c2;padding:0;margin:auto;width:144px;height:40px;color: #0089c2;;text-align:center;background-color: white;border-radius: 4px;">Ajouter</button>
					</div>
				</div>
			</div>
		</div>
	</div>
    </div>
  </body>
</html>	